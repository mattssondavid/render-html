<!DOCTYPE html>
<html>
    <head>
        <title>Test</title>
        <script>
            const css = (strings, ...substitutions) => {
                const content = String.raw({ raw: strings }, ...substitutions);
                const sheet = new CSSStyleSheet();
                sheet.replaceSync(content);
                return sheet;
            };
        </script>
    </head>
    <body>
        <main>
            <serializable-adopted-stylesheets-element
                >Hello there</serializable-adopted-stylesheets-element
            >
        </main>
        <script>
            class SerializableAdoptedStylesheetsElement extends HTMLElement {
                constructor() {
                    super();
                }

                connectedCallback() {
                    if (!this.shadowRoot) {
                        const template = document.createElement('template');
                        template.innerHTML = `<slot></slot>`;

                        const style = css`
                            :host {
                                background-color: white;
                            }
                        `;

                        const shadow = this.attachShadow({
                            mode: 'open',
                            serializable: true,
                        });

                        shadow.appendChild(template.content.cloneNode(true));
                        shadow.adoptedStyleSheets.push(style);

                        console.log(shadow.styleSheets.length);
                        console.log(shadow.adoptedStyleSheets.length);

                        const styles = shadow.adoptedStyleSheets.map(
                            (sheet) => {
                                console.log(sheet);
                                const rules = [...sheet.cssRules].map(
                                    (rule) => rule.cssText
                                );
                                const styleElement =
                                    shadow.ownerDocument.createElement('style');
                                styleElement.textContent = rules.join('');
                                shadow.insertBefore(
                                    styleElement,
                                    shadow.firstChild
                                );
                                return styleElement;
                            }
                        );
                        console.log(styles);

                        // const injectedStyles = [];
                        // for (const sheet of shadow.adoptedStyleSheets ?? []) {
                        //     const styleEl =
                        //         shadow.ownerDocument.createElement('style');
                        //     styleEl.textContent = sheet.cssText || '';
                        //     // Insert at the top
                        //     shadow.insertBefore(styleEl, shadow.firstChild);
                        //     injectedStyles.push(styleEl);
                        // }
                        // console.log(injectedStyles);
                    }
                }
            }
            if (
                !customElements.get('serializable-adopted-stylesheets-element')
            ) {
                customElements.define(
                    'serializable-adopted-stylesheets-element',
                    SerializableAdoptedStylesheetsElement
                );
            }
        </script>
    </body>
</html>
